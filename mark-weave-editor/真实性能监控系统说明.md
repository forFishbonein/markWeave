# 真实性能监控系统 - 技术说明

## 📊 系统概述

本系统已完全移除模拟数据，实现了基于真实 WebSocket 通信和用户操作的性能监控，适用于学术研究和论文分析。

## 🔥 主要改进

### 1. OT 性能监控器 (`otPerformanceMonitor.js`)

#### 移除的模拟数据：

- ❌ `simulateOperationResponse()` - 模拟操作响应函数
- ❌ `setTimeout()` + `Math.random()` - 随机延迟模拟
- ❌ `bytesReceived: this.metrics.totalOperationSize * 0.1` - 估算接收字节数
- ❌ 固定的 50ms 基础延迟

#### 新增的真实数据收集：

- ✅ **真实 WebSocket 消息拦截**：监控实际发送和接收的消息
- ✅ **真实网络字节统计**：准确计算发送和接收的字节数
- ✅ **真实延迟测量**：基于用户操作和服务器响应的时间差
- ✅ **真实连接状态监控**：WebSocket 连接、断开、错误事件
- ✅ **数据真实性标记**：`isReal: true` 标记确保数据来源可追溯

#### 核心技术实现：

```javascript
// 真实WebSocket消息拦截
const originalSend = ws.send;
ws.send = (data) => {
  this.handleWebSocketSend(data); // 记录真实发送数据
  return originalSend.call(ws, data);
};

// 真实延迟计算
const latency = timestamp - matchedOperation.timestamp;
if (latency >= 1 && latency <= 5000) {
  this.metrics.operationLatencies.push({
    latency,
    isReal: true, // 标记为真实数据
  });
}
```

### 2. 连接管理 (`useOTEditor.js`)

#### 移除的模拟行为：

- ❌ `Math.random() * 2000` - 连接随机延迟
- ❌ 人为的连接时序控制

#### 改进为真实连接：

- ✅ **自然连接时序**：多窗口按真实网络条件建立连接
- ✅ **真实重试机制**：基于实际连接失败的重试逻辑
- ✅ **真实连接状态**：准确反映 WebSocket 连接状态

### 3. Yjs 性能监控器 (`RealYjsMonitor.js`)

#### 已有的真实数据收集：

- ✅ **真实文档更新监听**：`ydoc.on('update')`
- ✅ **真实 awareness 变化**：`awareness.on('change')`
- ✅ **真实 WebSocket 拦截**：监控实际网络传输
- ✅ **真实多窗口协作**：基于 localStorage 的跨窗口数据同步

## 📈 真实性能指标

### 网络性能指标

- **真实延迟测量**：用户操作到服务器响应的实际时间
- **真实带宽统计**：WebSocket 消息的实际字节数
- **真实连接状态**：WebSocket 的实际连接稳定性
- **真实消息频率**：每秒实际发送/接收的消息数

### 用户操作指标

- **真实按键统计**：实际的键盘输入事件
- **真实操作队列**：待处理的用户操作数量
- **真实编辑效率**：基于实际用户行为的编辑模式

### 协作性能指标

- **真实多窗口检测**：基于 localStorage 的活跃窗口数量
- **真实用户状态**：awareness 系统的实际协作者信息
- **真实冲突解决**：OT/CRDT 算法的实际冲突处理

## 🔬 学术价值

### 数据可信度

1. **完全真实的网络延迟**：基于实际 WebSocket 往返时间
2. **准确的带宽使用**：精确的字节级网络传输统计
3. **真实的用户行为**：基于实际键盘输入和编辑操作
4. **可验证的多窗口协作**：真实的多用户协作场景

### 数据完整性标记

```javascript
return {
  // 数据真实性标记
  dataSource: "real-websocket-monitoring",
  hasRealNetworkData: this.metrics.networkEvents.length > 0,
  hasRealLatencyData:
    this.metrics.operationLatencies.filter((l) => l.isReal).length > 0,
};
```

### 学术研究适用性

- ✅ **可重现的实验**：基于真实网络条件和用户行为
- ✅ **可信的对比数据**：OT vs CRDT 的真实性能差异
- ✅ **详细的原始数据**：完整的操作历史和网络事件记录
- ✅ **标准化的导出格式**：JSON 格式的学术数据导出

## 🛠️ 技术架构

### 真实数据收集流程

```
用户操作 → 键盘事件监听 → 操作队列 → WebSocket发送 → 服务器处理 → WebSocket接收 → 延迟计算 → 性能统计
```

### 多窗口数据同步

```
窗口A数据 → localStorage → 窗口B监听 → 数据合并 → 统一性能视图
```

### 网络监控机制

```
WebSocket.send拦截 → 消息大小计算 → 发送统计
WebSocket.onmessage拦截 → 响应时间记录 → 延迟统计
```

## 📊 数据导出格式

系统提供标准化的学术数据导出：

```json
{
  "algorithm": "CRDT-Yjs | ShareDB-OT",
  "dataSource": "real-websocket-monitoring",
  "performance": {
    "averageLatency": "真实平均延迟",
    "p95Latency": "真实P95延迟",
    "throughput": "真实吞吐量",
    "bandwidthEfficiency": "真实带宽效率"
  },
  "dataIntegrity": {
    "hasRealNetworkData": true,
    "hasRealLatencyData": true,
    "latencySamples": "延迟样本数量",
    "networkEvents": "网络事件数量"
  },
  "rawData": {
    "operationLatencies": "完整的延迟记录",
    "networkEvents": "完整的网络事件",
    "userOperations": "完整的用户操作"
  }
}
```

## 🎯 使用建议

### 学术研究

1. **开启监控后进行真实编辑**：输入文字、格式化、删除等操作
2. **多窗口协作测试**：同时在多个浏览器窗口中编辑
3. **长时间数据收集**：建议监控 5-10 分钟以获得稳定数据
4. **导出原始数据**：用于详细的学术分析和图表制作

### 性能对比

1. **相同条件测试**：在相同网络环境下测试 OT 和 CRDT
2. **多场景验证**：单用户、双用户、多用户场景
3. **重复实验**：多次实验确保数据的一致性和可靠性

## 🔍 验证方法

### 数据真实性验证

1. **网络抓包对比**：使用 Wireshark 等工具验证 WebSocket 流量
2. **延迟合理性检查**：延迟值应在 1-5000ms 的合理范围内
3. **操作匹配验证**：用户操作与服务器响应的时间匹配
4. **多窗口一致性**：不同窗口的数据应该能够合并

### 学术标准符合性

- ✅ **数据可重现性**：相同条件下可重现相似结果
- ✅ **数据完整性**：包含完整的原始数据和元数据
- ✅ **数据可追溯性**：每个数据点都有明确的来源标记
- ✅ **数据标准化**：符合学术论文的数据表述要求

---

**总结**：本系统已完全移除所有模拟数据，实现了基于真实 WebSocket 通信、用户操作和网络条件的性能监控，适用于高质量的学术研究和论文发表。
